- name: "show stack"
  debug:
    msg: "STACK: {{ item }}"
  with_items: 
    - "{{ stack.stack_outputs }}"
  when: stack is defined

- name: "register inventory"
  ec2_instance_info:
    aws_access_key: "{{ aws_access_key_id }}"
    aws_secret_key: "{{ aws_secret_access_key }}"
    region: "{{ aws_region }}"
    filters:
        "tag:environment": "{{environment_tag}}"
  register: ec2_i


- name: Add instance to host group
  add_host:
    hostname: "{{ item }}"
    groupname: ec2_group
  loop: "{{ ec2_i | json_query('instances[*].network_interfaces[0].association.public_ip') }}"

- name: Wait for SSH to come up
  local_action:
    module: wait_for
    host: "{{ item }}"
    port: 22
    delay: 10
    timeout: 120
  loop: "{{ groups.ec2_group }}"

  - name: Wait for SSH to come up
    module: wait_for
    host: "{{ item }}"
    port: 22
    delay: 10
    timeout: 120
  loop: "{{ groups.ec2_group }}"